---
import type { Tech } from 'recivi'

import Link from '@/components/Link.astro'
import Icon from '@/components/Icon.astro'
import IconName from '@/components/IconName.astro'
import TimePeriod from '@/components/TimePeriod.astro'
import DateComponent from '@/components/Date.astro'

import type { ColumnSpec, Row } from '@/models/table'

interface Props {
  columns: ColumnSpec[]
  data: Row[]
}
const { columns, data } = Astro.props

const columnIds = columns.map((column) => column.id)

const pathName = new URL(Astro.request.url).pathname
function isCurr(row: Row) {
  return Boolean(row.url) && pathName.includes(row.url ?? '')
}
---

<!-- Padding must be removed because cells are padded individually. -->
<table class="cntnr px-0 transition">
  <thead class="border-y bg-surface0">
    <tr>
      {
        columns.map((column: ColumnSpec) => (
          <th
            scope="col"
            class:list={[{ 'w-px whitespace-nowrap': !column.isExpanding }]}>
            {column.name ?? column.id}
          </th>
        ))
      }
    </tr>
  </thead>
  <tbody>
    {
      data.map((row, idx) => (
        <tr
          class="relative transition after:absolute after:inset-y-0 after:start-0 after:bg-red hover:bg-surface0 [&[data-is-curr]]:bg-surface0 [&[data-is-curr]]:after:w-1"
          class:list={[{ 'border-b': row.isLastSibling }]}
          data-group-id={row.groupId ?? idx}
          data-is-curr={isCurr(row)}>
          {Object.entries(row.data)
            .filter(([key]) => columnIds.includes(key as keyof typeof row.data))
            .sort(
              ([a], [b]) =>
                columnIds.indexOf(a as keyof typeof row.data) -
                columnIds.indexOf(b as keyof typeof row.data)
            )
            .map(([key, value], idx) => (
              <td
                class:list={[
                  { 'w-px whitespace-nowrap': !columns[idx]?.isExpanding },
                ]}>
                {key === 'epic' || key === 'org' || key === 'institute' ? (
                  <IconName
                    {...value}
                    url={row.url}
                  />
                ) : key === 'title' ? (
                  row.url ? (
                    <Link url={row.url}>{value}</Link>
                  ) : (
                    value
                  )
                ) : key === 'post' ? (
                  <div class="flex flex-col">
                    {row.url ? (
                      <Link url={row.url}>{value.data.title}</Link>
                    ) : (
                      value.data.title
                    )}
                    <ul class="text-subtle">
                      {value.data.categories.map((category: string) => (
                        <li
                          class="inline-block after:mr-1 after:content-['·'] last:after:content-none [&[data-is-highlighted]]:text-red"
                          data-category={category}>
                          {category}
                        </li>
                      ))}
                    </ul>
                  </div>
                ) : key === 'link' ? (
                  value && <Link url={value} />
                ) : key === 'tech' ? (
                  <ul>
                    {value.map((item: Tech) => (
                      <li
                        title={item.name}
                        class="inline-block after:mr-1 after:text-subtle after:content-['·'] last:after:content-none">
                        <Icon name={item.id} />
                      </li>
                    ))}
                  </ul>
                ) : key === 'period' ? (
                  <TimePeriod {...value} />
                ) : key === 'published' ||
                  key === 'updated' ||
                  key === 'issued' ? (
                  <DateComponent date={value} />
                ) : (
                  value
                )}
              </td>
            ))}
        </tr>
      ))
    }
  </tbody>
</table>

<script>
  /** Handle dimming of unrelated rows in a hovered table. */

  function handleHover(event: MouseEvent) {
    if (!(event.target instanceof HTMLTableRowElement)) {
      return
    }

    const func: 'add' | 'remove' =
      event.type === 'mouseenter' ? 'add' : 'remove'

    const table = event.target.closest('table')
    if (!table) {
      return
    }

    const allTrs = table.getElementsByTagName('tr')

    for (const tr of allTrs) {
      if (tr.dataset.groupId === event.target.dataset.groupId) {
        tr.classList[func]('motion-reduce:bg-surface0')
      } else {
        tr.classList[func]('opacity-30', 'motion-reduce:opacity-70')
      }
    }
  }

  document.querySelectorAll('tr').forEach((tr) => {
    tr.addEventListener('mouseenter', handleHover)
    tr.addEventListener('mouseleave', handleHover)
  })
</script>
